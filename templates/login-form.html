<!DOCTYPE html>
<html>
<head>
	<title>Login Form</title>
	<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>
	<div class="container">
        <h2 class="text-center">Login Form</h2>
        <form id="login-form" method="POST" class="needs-validation" novalidate>
            <div class="form-group">
                <label for="username">Username:</label>
                <input type="text" id="username" name="username" class="form-control" required>
                <div class="invalid-feedback">Please enter your username.</div>
            </div>
            <div class="form-group">
                <label for="password">Password:</label>
                <input type="password" id="password" name="password" class="form-control" required>
                <div class="invalid-feedback">Please enter your password.</div>
            </div>
            <input type="hidden" name="next" value="/home">
            <button type="submit" class="btn btn-primary" id="submit-btn" disabled>Submit</button>
        </form>
    </div>
	<script>
        const loginForm = document.querySelector('#login-form');
        const submitButton = document.querySelector('#submit-btn');
        const usernameInput = document.querySelector('#username');
        const passwordInput = document.querySelector('#password');

		const toggleSubmitButton = () => {
            if (usernameInput.value && passwordInput.value) {
                submitButton.removeAttribute('disabled');
            } else {
                submitButton.setAttribute('disabled', true);
            }
        };

        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
			if (!loginForm.checkValidity()) {
                event.stopPropagation();
                loginForm.classList.add('was-validated');
                return;
            }
            const formData = new FormData(loginForm);
            const response = await fetch('/login', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                window.location.href = data.redirect_url;
            } else {
                const errorMessage = document.createElement('div');
				errorMessage.classList.add('invalid-feedback')
                errorMessage.textContent = data.message;
                loginForm.querySelector('#password').classList.add('is-invalid');
                loginForm.querySelector('#password').insertAdjacentElement('afterend', errorMessage);
                loginForm.classList.add('was-validated');
            }
        });

		usernameInput.addEventListener('input', toggleSubmitButton)
		passwordInput.addEventListener('input', toggleSubmitButton)
    </script>
</body>
</html>
